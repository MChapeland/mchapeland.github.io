<!DOCTYPE html>
<html>

<head>

	<!-- Title of the page -->
	<title>Project World Map</title>

	<!-- Page Setup -->
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=2.0" />
	<meta http-equiv="X-UA-Compatible" content="ie-edge" />

	<link rel="stylesheet" href="index.css" />
	<link rel="stylesheet" href="src/sidebar.css" />
	<script src="src/sidebar.js" defer></script>

	<!-- Leaflet Scripts -->
	<link rel="stylesheet" href="src/leaflet.css" />
	<script src="src/leaflet.js"></script>

</head>


<body>

	<!-- Map -->
	<div id="map"></div>

	<!-- Sidebar -->
	<div class="sidebar" id="Main">

		<div class="sidebar-grid">
		
			<div class="sidebar-logo">
				<img src="src/images/logo.svg" />
			</div>

			<div></div>

			<button class="sidebar-button" id="SearchButton" onclick="toggleDrop(event, 'Search')">
				<img src="src/images/icons/search.svg" />
			</button>

			<button class="sidebar-button" id="LayersButton" onclick="toggleDrop(event, 'Layers')">
				<img src="src/images/icons/layers.svg" />
			</button>

			<button class="sidebar-button" id="OptionsButton" onclick="toggleDrop(event, 'Options')">
				<img src="src/images/icons/options.svg" />
			</button>

		</div>

	</div>

	<!-- SIDEBAR DROPS -->
	<!-- Search -->
	<div class="tabs" id="Search">

		<div class="label-container">
			<label>Search</label>
		</div>

		<div class="search-box">

			<input class="searchInput" type="text" placeholder="Search Markers" />

			<button class="search-button" href="#">
				<img src="src/images/icons/search.svg" />
            </button>

		</div>
		<!-- 
		<div class="search-result">
			<label>John</label>
		</div>
		-->

	</div>

	<!-- Layers -->
	<div class="tabs" id="Layers">

		<div class="label-container">
			<label>Layers</label>
		</div>

		<!--

		<div id="x" class="custom-layer-group">

			<div class="group-container">

				<div class="arrow-container">
					<div class="arrow"></div>
					<input type="checkbox" >
				</div>
				
				<label>NPCs</label>

				<div class="visibility-box">
					<input type="checkbox" checked>
				</div>

            </div>
			
			<div class="layer-container">
				<label>John</label>
				<div class="visibility-box">
					<input type="checkbox" checked>
				</div>
			</div>

		</div>

		-->

	</div>

	<!-- Options -->
	<div class="tabs" id="Options">

		<div class="label-container">
			<label>Options</label>
		</div>

	</div>

	<script>

		//Map Setup
		var map = L.map('map', { 'attributionControl': false, zoomControl: false }).setView([-15, 15], 2);

		var tiles = L.tileLayer('map/{z}/{x}/{y}.png', {
			continuousWorld: false,
			noWrap: true,
			minZoom: 2,
			maxZoom: 4
		}).addTo(map);

		var BaseIcon = L.Icon.extend({
			options: {
				shadowUrl: 'src/images/marker-shadow.png',
				iconSize: [25],
				shadowSize: [40, 50],
				iconAnchor: [13, 45],
				shadowAnchor: [8, 55],
				popupAnchor: [0, -58],
				tooltipAnchor: [29.5, 10]
			}
		});


        // Data fetched from Google Sheets
        const sheetID = '1lB1RY3fwmw9k0t_M4vQt6z__ieHWX7frPUhjbey-9S0';
        const base = 'https://docs.google.com/spreadsheets/d/1lB1RY3fwmw9k0t_M4vQt6z__ieHWX7frPUhjbey-9S0/gviz/tq?';

        const sheetName = 'users';

        const query = encodeURIComponent('Select *');

        const url = `${base}&sheet=${sheetName}&tq=${query}`;

        document.addEventListener('DOMContentLoaded', sheetExtract);

        function sheetExtract() {
            fetch(url)
                .then(res => res.text())
                .then(rep => {

                    const refinedData = JSON.parse(rep.substr(47).slice(0, -2));

                    refinedData.table.rows.forEach((main) => {

                        const name = main.c[0].v;
                        const y = main.c[1].v;
                        const x = main.c[2].v;
                        const group = main.c[3].v;
                        const layer = main.c[4].v;
                        const color = main.c[5].v;
                        const symbol = main.c[6].v;
                        const desc = main.c[7].v;
                        const id = main.c[8].v;

						if (document.getElementById(`LG${group}`) == null){
							//Create a new layer group
							let newLayerGroup = document.createElement("div");
							newLayerGroup.classList.add('custom-layer-group');
							newLayerGroup.id = `LG${group}`;

								//In the layer group create a group container
								let newGroupContainer = document.createElement("div");
								newGroupContainer.classList.add('group-container');
								newLayerGroup.appendChild(newGroupContainer);
								
									//In the group container create an arrow container
									let newArrowContainer = document.createElement("div");
									newArrowContainer.classList.add('arrow-container');
									newGroupContainer.appendChild(newArrowContainer);
									
										//In the arrow container create an arrow
										let newArrow = document.createElement("div");
										newArrow.classList.add('arrow');
										newArrowContainer.appendChild(newArrow);

										//In the arrow container create a checkbox
										let newACCheckbox = document.createElement("input");
										newACCheckbox.type = "checkbox";
										newACCheckbox.checked = false;
										newArrowContainer.appendChild(newACCheckbox);

									//In the group container create a label
									let newLabel = document.createElement("label");
									newLabel.innerText = `${group}`;
									newGroupContainer.appendChild(newLabel);

									//In the group container create a visibility box
									let newVisibilityBox = document.createElement("div");
									newVisibilityBox.classList.add('visibility-box');
									newGroupContainer.appendChild(newVisibilityBox);

										//In the visibility box create a checkbox
										let newVBCheckbox = document.createElement("input");
										newVBCheckbox.type = "checkbox";
										newVBCheckbox.checked = true;
										newVisibilityBox.appendChild(newVBCheckbox);

							//Append the whole thing to the Layers tab
							document.getElementById("Layers").appendChild(newLayerGroup);

						}

						if (document.getElementById(`MG${layer}LG${group}`) == null){
							
							//Create a new marker group
							let newMarkerGroup = document.createElement("div");
							newMarkerGroup.classList.add('layer-container');
							newMarkerGroup.id = `MG${layer}LG${group}`;
								
								//In the marker group create a label
								let newLabel = document.createElement("label");
								newLabel.innerText = `${layer}`;
								newMarkerGroup.appendChild(newLabel);
								
								//In the marker group create a visibility box
								let newBox = document.createElement("div");
								newBox.classList.add('visibility-box');
								newMarkerGroup.appendChild(newBox);

									//In the visibility box create a checkbox
									let newCheckbox = document.createElement("input");
									newCheckbox.type = "checkbox";
									newCheckbox.checked = true;
									newBox.appendChild(newCheckbox);
						
							//Append the whole thing to the proper layer group
							document.getElementById(`LG${group}`).appendChild(newMarkerGroup);

						}

                        marker = L
							.marker([Number(y), Number(x)], {	icon: new BaseIcon({ iconUrl: `src/images/markers/marker-${color.toLowerCase()}.svg`}) })
							.addTo(map)
							.bindPopup(`<label><b>${name}</b></label><br /><p>${desc}</p><br /><p>${id}</p>`, {closeButton: false})
							.bindTooltip(name);
                        
                    });
                });
        }


	</script>


</html>