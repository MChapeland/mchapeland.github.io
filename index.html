<!DOCTYPE html>
<html>
<head>

    <!-- Title of the page -->
    <title>Project World Map</title>

    <!-- Page Setup -->
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=2.0" />
    <meta http-equiv="X-UA-Compatible" content="ie-edge" />

    <!-- Index Scripts -->
    <link tag="indexCSS" rel="stylesheet" type="text/css" href="index.css" />

    <!-- Leaflet Scripts -->
    <link tag="leafletCSS" rel="stylesheet" href="scripts/leaflet.css" />
    <script tag="leafletJS" src="scripts/leaflet.js"></script>

</head>


<body>

    <div id="map"></div>

    <div class="header">
        <label>PROJECT MAP</label>
    </div>

    <div class="header-drop">
    </div>




    <script>

        //Map Setup
        var map = L.map('map'; { attributionControl: false }).setView([-15, 15], 2);

        var tiles = L.tileLayer('map/{z}/{x}/{y}.png', {
            continuousWorld: false,
            noWrap: true,
            minZoom: 2,
            maxZoom: 4,
        }).addTo(map);

        var BaseIcon = L.Icon.extend({
            options: {
                shadowUrl: 'img/marker-shadow.png',
                iconSize: [30],
                shadowSize: [50, 64],
                iconAnchor: [3, 48],
                shadowAnchor: [3, 63],
                popupAnchor: [11, -50]
            }
        });


        // Data fetched from Google Sheets
        const sheetID = '1lB1RY3fwmw9k0t_M4vQt6z__ieHWX7frPUhjbey-9S0';
        const base = 'https://docs.google.com/spreadsheets/d/1lB1RY3fwmw9k0t_M4vQt6z__ieHWX7frPUhjbey-9S0/gviz/tq?';

        const sheetName = 'users';

        const query = encodeURIComponent('Select *');

        const url = `${base}&sheet=${sheetName}&tq=${query}`;

        document.addEventListener('DOMContentLoaded', sheetExtract);

        function sheetExtract() {
            fetch(url)
                .then(res => res.text())
                .then(rep => {

                    const refinedData = JSON.parse(rep.substr(47).slice(0, -2));

                    refinedData.table.rows.forEach((main) => {

                        const name = main.c[0].v;
                        const y = main.c[1].v;
                        const x = main.c[2].v;
                        const layer = main.c[3].v;
                        const color = main.c[4].v;
                        const symbol = main.c[5].v;
                        const desc = main.c[6].v;

                        marker = L.marker([Number(y), Number(x)], { icon: new BaseIcon({ iconUrl: `img/marker-icon-${color.toLowerCase()}.svg` }) }).addTo(map).bindPopup(`<b>${name}</b><br />${desc}`);

                    });
                });
        }

    </script>
</body>
    </html>
