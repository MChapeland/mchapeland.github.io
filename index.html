<!DOCTYPE html>
<html>
<head>

    <!-- Title of the page -->
    <title>Project World Map</title>

    <!-- Page Setup -->
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=2.0" />
    <meta http-equiv="X-UA-Compatible" content="ie-edge" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Share+Tech">

    <!-- Index Scripts -->
    <link tag="indexCSS" rel="stylesheet" type="text/css" href="index.css" />

    <!-- Leaflet Scripts -->
    <link tag="leafletCSS" rel="stylesheet" href="scripts/leaflet.css" />
    <script tag="leafletJS" src="scripts/leaflet.js"></script>

</head>


<body>

    <!-- Map -->
    <div id="map"></div>

    <!-- Sidebar -->
    <div class="sidebar" id="Main">

        <div></div>

        <div class="sidebar-logo">
            <img src="img/tabs/logo.png" />
            <img src="img/tabs/divider.png" />
        </div>

        <button class="sidebar-button" id="SearchButton" onclick="toggleDrop(event, 'Search')">
            <img src="img/tabs/search.png" />
        </button>

        <button class="sidebar-button" id="LayersButton" onclick="toggleDrop(event, 'Layers')">
            <img src="img/tabs/layers.png" />
        </button>

        <button class="sidebar-button" id="MarkersButton" onclick="toggleDrop(event, 'Markers')">
            <img src="img/tabs/markers.png" />
        </button>

        <button class="sidebar-button" id="PathsButton" onclick="toggleDrop(event, 'Paths')">
            <img src="img/tabs/paths.png" />
        </button>

        <button class="sidebar-button" id="StatsButton" onclick="toggleDrop(event, 'Stats')">
            <img src="img/tabs/stats.png" />
        </button>

        <button class="sidebar-button" id="OptionsButton" onclick="toggleDrop(event, 'Options')">
            <img src="img/tabs/options.png" />
        </button>

    </div>

    <!-- SIDEBAR DROPS -->
    <!-- Search-->
    <div class="sidebarDrop" id="Search">
        <div></div>
        <label>Search</label>
    </div>

    <!-- Layers-->
    <div class="sidebarDrop" id="Layers">
        <div></div>
        <label>Layers</label>

    </div>

    <!-- Markers-->
    <div class="sidebarDrop" id="Markers">
        <div></div>
        <label>Markers</label>

    </div>

    <!-- Paths-->
    <div class="sidebarDrop" id="Paths">
        <div></div>
        <label>Paths</label>

    </div>

    <!-- Stats-->
    <div class="sidebarDrop" id="Stats">
        <div></div>
        <label>Stats</label>

    </div>

    <!-- Options-->
    <div class="sidebarDrop" id="Options">
        <div></div>
        <label>Options</label>

    </div>




    <script>

        //Sidebar Setup
        var tabOpened = false;
        var currentTab = "None";
        var closingTab = "None";
        var currentButton = "None";

        function toggleDrop(evt, tab) {

            switch (tabOpened) {

                case true:
                    if (currentTab != tab) {
                        closingTab = currentTab;
                        closeTab();
                        currentTab = tab;
                        setTimeout(openTab, 250);
                        evt.currentTarget.className += " active";
                    }
                    else {
                        tabOpened = false;
                        closeTab();
                        evt.currentTarget.className = "sidebar-button";
                    }
                    break;

                case false:
                    currentTab = tab;
                    closingTab = currentTab;
                    openTab();
                    tabOpened = true;
                    evt.currentTarget.className += " active";
                    break;

            }
        }

        function closeTab() {
            document.getElementById(`${closingTab}Button`).className = "sidebar-button";
            document.getElementById(currentTab).style.transform = "translateX(-200px)";
            setTimeout(hideTab, 250);
        }

        function hideTab() {

            switch (tabOpened) {

                case true:
                    document.getElementById(closingTab).style.display = "none";
                    document.getElementById(closingTab).style.boxshadow = "none";
                    break;

                case false:
                    document.getElementById(currentTab).style.display = "none";
                    document.getElementById(currentTab).style.boxshadow = "none";
                    document.getElementById("Main").style.boxShadow = "rgba(18, 18, 18, 0.8) 0px 0px 10px 0px";
                    break;

            }
        }

        function openTab() {
            document.getElementById(currentTab).style.display = "grid";
            setTimeout(showTab, 15);
            document.getElementById("Main").style.boxShadow = "none";
        }

        function showTab() {
            document.getElementById(currentTab).style.transform = "translateX(0px)";
            document.getElementById(currentTab).style.boxShadow = "rgba(18, 18, 18, 0.8) 0px 0px 10px 0px";
        }



        //Map Setup
        var map = L.map('map', { 'attributionControl': false }).setView([-15, 15], 2);

        var tiles = L.tileLayer('map/{z}/{x}/{y}.png', {
            continuousWorld: false,
            noWrap: true,
            minZoom: 2,
            maxZoom: 4,
        }).addTo(map);

        var BaseIcon = L.Icon.extend({
            options: {
                shadowUrl: 'img/marker-shadow.png',
                iconSize: [30],
                shadowSize: [50, 64],
                iconAnchor: [3, 48],
                shadowAnchor: [3, 63],
                popupAnchor: [11, -50]
            }
        });


        // Data fetched from Google Sheets
        const sheetID = '1lB1RY3fwmw9k0t_M4vQt6z__ieHWX7frPUhjbey-9S0';
        const base = 'https://docs.google.com/spreadsheets/d/1lB1RY3fwmw9k0t_M4vQt6z__ieHWX7frPUhjbey-9S0/gviz/tq?';

        const sheetName = 'users';

        const query = encodeURIComponent('Select *');

        const url = `${base}&sheet=${sheetName}&tq=${query}`;

        document.addEventListener('DOMContentLoaded', sheetExtract);

        function sheetExtract() {
            fetch(url)
                .then(res => res.text())
                .then(rep => {

                    const refinedData = JSON.parse(rep.substr(47).slice(0, -2));

                    refinedData.table.rows.forEach((main) => {

                        const name = main.c[0].v;
                        const y = main.c[1].v;
                        const x = main.c[2].v;
                        const layer = main.c[3].v;
                        const color = main.c[4].v;
                        const symbol = main.c[5].v;
                        const desc = main.c[6].v;

                        group = L.layerGroup(layer).addTo(map);

                        marker = L.marker([Number(y), Number(x)], { icon: new BaseIcon({ iconUrl: `img/marker-icon-${color.toLowerCase()}.svg` }) }).addTo(layer).bindPopup(`<b>${name}</b><br />${desc}`);

                    });
                });
        }

    </script>
</body>
        </html>
