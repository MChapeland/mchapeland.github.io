<!DOCTYPE html>
<html>
<head>

    <!-- Title of the page -->
    <title>Project World Map</title>

    <!-- Page Setup -->
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=2.0" />
    <meta http-equiv="X-UA-Compatible" content="ie-edge" />

    <!-- Index Scripts -->
    <link tag="indexCSS" rel="stylesheet" type="text/css" href="index.css" />

    <!-- Leaflet Scripts -->
    <link tag="leafletCSS" rel="stylesheet" href="scripts/leaflet.css" />
    <script tag="leafletJS" src="scripts/leaflet.js"></script>

</head>


<body>

    <!-- Map -->
    <div id="map"></div>

    <!-- Sidebar -->
    <div class="sidebar">

        <div></div>

        <div class="sidebar-logo">
            <img src="img/tabs/logo.png" />
            <img src="img/tabs/divider.png" />
        </div>

        <button class="sidebar-button" onclick="openDrop(event, 'Search')">
            <img src="img/tabs/search.png" />
        </button>

        <button class="sidebar-button" onclick="openDrop(event, 'Layers')">
            <img src="img/tabs/layers.png" />
        </button>

        <button class="sidebar-button" onclick="openDrop(event, 'Markers')">
            <img src="img/tabs/markers.png" />
        </button>

        <button class="sidebar-button" onclick="openDrop(event, 'Paths')">
            <img src="img/tabs/paths.png" />
        </button>

        <button class="sidebar-button" onclick="openDrop(event, 'Stats')">
            <img src="img/tabs/stats.png" />
        </button>

        <button class="sidebar-button" onclick="openDrop(event, 'Options')">
            <img src="img/tabs/options.png" />
        </button>

    </div>

    <!-- SIDEBAR DROPS -->
    <!-- Search
    <div class="sidebarDrop" id="sidebarDropSearch">

    </div>-->
    <!-- Layers
    <div class="sidebarDrop" id="sidebarDropLayers">

    </div>-->
    <!-- Markers
    <div class="sidebarDrop" id="sidebarDropMarkers">

    </div>-->
    <!-- Paths
    <div class="sidebarDrop" id="sidebarDropPaths">

    </div>-->
    <!-- Stats
    <div class="sidebarDrop" id="sidebarDropStats">

    </div>-->
    <!-- Options
    <div class="sidebarDrop" id="sidebarDropOptions">

    </div>-->




    <script>
        //Sidebar Setup
        function openDrop(evt, tab) {
            // Declare all variables
            var i, tabcontent, tablinks;

            // Get all elements with class="tabcontent" and hide them
            tabcontent = document.getElementsByClassName("sidebarDrop");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }

            // Get all elements with class="tablinks" and remove the class "active"
            tablinks = document.getElementsByClassName("sidebar-button");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }

            // Show the current tab, and add an "active" class to the button that opened the tab
            document.getElementById(tab).style.display = "block";
            evt.currentTarget.className += " active";
        }


        //Map Setup
        var map = L.map('map', { 'attributionControl': false }).setView([-15, 15], 2);

        var tiles = L.tileLayer('map/{z}/{x}/{y}.png', {
            continuousWorld: false,
            noWrap: true,
            minZoom: 2,
            maxZoom: 4,
        }).addTo(map);

        var BaseIcon = L.Icon.extend({
            options: {
                shadowUrl: 'img/marker-shadow.png',
                iconSize: [30],
                shadowSize: [50, 64],
                iconAnchor: [3, 48],
                shadowAnchor: [3, 63],
                popupAnchor: [11, -50]
            }
        });


        // Data fetched from Google Sheets
        const sheetID = '1lB1RY3fwmw9k0t_M4vQt6z__ieHWX7frPUhjbey-9S0';
        const base = 'https://docs.google.com/spreadsheets/d/1lB1RY3fwmw9k0t_M4vQt6z__ieHWX7frPUhjbey-9S0/gviz/tq?';

        const sheetName = 'users';

        const query = encodeURIComponent('Select *');

        const url = `${base}&sheet=${sheetName}&tq=${query}`;

        document.addEventListener('DOMContentLoaded', sheetExtract);

        function sheetExtract() {
            fetch(url)
                .then(res => res.text())
                .then(rep => {

                    const refinedData = JSON.parse(rep.substr(47).slice(0, -2));

                    refinedData.table.rows.forEach((main) => {

                        const name = main.c[0].v;
                        const y = main.c[1].v;
                        const x = main.c[2].v;
                        const layer = main.c[3].v;
                        const color = main.c[4].v;
                        const symbol = main.c[5].v;
                        const desc = main.c[6].v;

                        marker = L.marker([Number(y), Number(x)], { icon: new BaseIcon({ iconUrl: `img/marker-icon-${color.toLowerCase()}.svg` }) }).addTo(map).bindPopup(`<b>${name}</b><br />${desc}`);

                    });
                });
        }

    </script>
</body>
    </html>
